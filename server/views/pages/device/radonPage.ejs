<!DOCTYPE html>
<html>

<head>
    <title>welcome Test IoF</title>
    <% include ../../partials/stylesheet.ejs %>
    <% include ../../partials/header_javascript.ejs %>
    <% include ../../partials/weather_config.ejs %>
</head>


<body class="hold-transition skin-blue sidebar-mini">
    <div class="wrapper">
        <header class="main-header">
            <!-- Logo -->
            <a href="/" class="logo">
                <!-- mini logo for sidebar mini 50x50 pixels -->
                <span class="logo-mini"><b>I</b>oF</span>
                <!-- logo for regular state and mobile devices -->
                <span class="logo-lg"><b>C &amp; H </b>IoF</span>
            </a>
            <!-- Header Navbar: style can be found in header.less -->
            <nav class="navbar navbar-static-top">
                <!-- Sidebar toggle button-->
                 <a href="#" class="sidebar-toggle" data-toggle="offcanvas" role="button">
                        <span class="sr-only">Toggle navigation</span>
                </a>
                <div class="navbar-custom-menu">
                    <ul class="nav navbar-nav">
                        <!-- Tasks: style can be found in dropdown.less -->
                        <!-- header nav 들어가는 부분 -->
                    </ul>
                </div>
            </nav>
        </header>
        <!-- Left side column. contains the logo and sidebar -->
        <aside class="main-sidebar">
            <!-- sidebar: style can be found in sidebar.less -->
            <section class="sidebar">
                <!-- Sidebar user panel -->
                <div class="user-panel">
                    <div class="pull-left image">
                        <img src="/static/images/logo_iot.png" class="img-circle" alt="User Image">
                    </div>
                    <div class="pull-left info">
                        
                        <!-- <a href="#"><i class="fa fa-circle text-success"></i> Online</a> -->
                    </div>
                </div>
                <!-- nav item -->
                <% include ../../partials/nav_item %>
                <!-- end nav item -->
            </section>
            <!-- /.sidebar -->
        </aside>
        <!-- Content Wrapper. Contains page content -->
        <div class="content-wrapper">
                <!-- Content Header (Page header) -->
                 <section class="content-header">
                    <h1>
                        Device <small>serial num or name</small>
                    </h1>
                    <ol class="breadcrumb">
                        <li><a href="/"><i class="fa fa-dashboard"></i> Home</a></li>
                        <li><i class="ffa fa-dshboard"></i><a href="/device/list">device</a></li>
                        <li class="active"><a href="#">detail</a></li>
                    </ol>
                </section> 
                <div class="content">
                    <div class="callout callout-info">
                    <h4>Device detail</h4>
                    <p>
                        how to use and show data detail subscript
                    </p>
                    </div>
                    <div class="row">
                    <!-- col md 6 start -->
                        <div class="col-xs-12">
                            <div class="box box-primary">
                                <div class="box-header with-border">
                                    <i class="fa fa-bar-chart-o"></i>
                                    <h3 class="box-title">show data</h3>
                                </div>
                                <!-- box header end -->
                                <div class="box-body">
                                    <div id="line-chart" style="height: 300px;"></div>
                                </div>
                            </div>
                            <!-- box end -->
                        </div>
                    <!-- col md 6 end first -->
                    </div>
                    <!-- iamge start first -->
                    <div class="row">
                    <!-- weather info start -->
                    <div class="col-md-6">
                        <!-- weather info  -->
                        <div class="box box-primary">
                            <div class="box-header with-border">
                                <i class="fa fa-cloud"></i>
                                <h3 class="box-title">Weather info</h3>
                                <div class="box-tools pull-right">
                                    <!-- <button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i>
                            </button>
                                    <button type="button" class="btn btn-box-tool" data-widget="remove"><i class="fa fa-times"></i></button> -->
                                </div>
                            </div>
                            <div class="box-body">
                                <div id="weater-info" style="height:300px">
                                    <iframe id="forecast_embed" type="text/html" frameborder="0" height="245" width="100%" src="http://forecast.io/embed/#lat=37.476902&lon=127.012939&name=seoul"> 
                                        </iframe>
                                    <div class="weather">


                                    </div>
                                </div>
                                <!-- /.box-body-->
                            </div>
                            <!--/.box  -->
                        </div>
                        <!-- weather info box end -->
                    </div>
                          <!-- controller start -->
                          <div class="col-md-6">
                                <div class="box box-primary">
                                    <div class="box-header with-border">
                                        <i class="fa fa-bar-chart-o"></i>
                                        <h3 class="box-title">control panel</h3>
                                    </div>
                                    <!-- box header end -->
                                    <div class="box-body" >
                                                <div id="controller" style="height:300px;">
                                                        <form action="" method="">
                                                            <div class="form-group">
                                                                <label>water setting </label>
                                                                <select>
                                                                    <option value="30">30초</option>
                                                                    <option value="60">1분</option>
                                                                    <option value="90">1분30초</option>
                                                                    <option value="120">2분</option>
                                                                </select>
                                                            </div>
                                                                <div class="form-group">
                                                                <label>shooting time </label>
                                                                <select>
                                                                        <option value="30">30분</option>
                                                                        <option value="60">1시간</option>
                                                                        <option value="90">1시간30분</option>
                                                                        <option value="120">2시간</option>
                                                                    </select>
                                                                    <br>
                                                                </div>
                                                                <hr>
                                                            <div class="form-group"style="text-align:center;">
                                                                <button type="button" id="controller_on" name="controller" class="btn btn-primary" style="width:15%;" value="on"><i class="fa fa-play"></i></button>
                                                                <button type="button" id="controller_off" name="controller" class="btn btn-danger" style="width:15%;" value="off"><i class="fa fa-stop"></i></button>
                                                            </div>
                                                        </form>
                                                    </div>
                                    </div>
                                    <!-- box body end -->
                                </div>
                            </div>
                            <!-- col md 6 end controller end first -->
                    </div>
                    </div>
                    <!-- row end -->
            </div>
        <% include ../../partials/footer.ejs %>
            <div class="control-sidebar-bg"></div>
        </div>
        <!-- /.content-wrapper -->
      
            <!-- /.control-sidebar -->
            <!-- Add the sidebar's background. This div must be placed
       immediately after the control sidebar -->
    </div>
    
    <% include ../../partials/footer_graph_javascript.ejs %>
  </body>
  <script>
$(function(){

    function labelFormatter(label, series) {
            return '<div style="font-size:13px; text-align:center; padding:2px; color: #fff; font-weight: 600;">' +
            label +
            "<br>" +
            Math.round(series.percent) +
            "%</div>";
    }
     //날짜에서 시간과분만 추출
    function getDateFromJSON(str) {
        var date = new Date(str);
        var con_mindate = date.getMinutes();
        if((0<= con_mindate && con_mindate  <= 15 )){
            date.setMinutes(00);
            return (date.getHours()) + ':0' + date.getMinutes();
        } else if(( 45<= con_mindate && con_mindate<= 60))
        {
            var date_time = date.getHours();
            date.setHours(date_time + 1);
            date.setMinutes(00);
            return (date.getHours()) + ':0' + date.getMinutes();
        }else{
            date.setMinutes(30);
            return (date.getHours()) + ':' + date.getMinutes();
        }  
    }
    //날짜에서 하루 빼기
    function getMinusOneDate(str) {
        var date = new Date(str);
        return date.getFullYear() + "-" + (date.getMonth() + 1) + "-" + (date.getDate() - 1);
    }
    //날짜 형식 변경
    function getFormatDate(date) {
        var year = date.getFullYear(); //yyyy
        var month = (1 + date.getMonth()); //M
        var day = date.getDate(); //d
        month = month >= 10 ? month : '0' + month; // month 두자리로 저장
        day = day >= 10 ? day : '0' + day; //day 두자리로 저장
        return year + '' + month + '' + day;
    }
    //시간말 추출
    function getFormatDateHour(date) {
        var hour = date.getHours(); //d
        hour = hour >= 10 ? hour : '0' + hour; //day 두자리로 저장
        return hour;
    }

    var data_chart = {
        cnt:0,
        chart:'',
        init:function(data){
            this.cnt = 1;
            this.chart = $.plot("#line-chart", data, {
                grid:{
                    hoverable: true,
                    borderColor: "#f3f3f3",
                    borderWidth: 1,
                    tickColor: "#f3f3f3"
                },
                series:{
                    shadowSize:0,
                    lines:{
                        show:true,
                    },
                    points:{
                        show:true,
                    }
                },
                lines:{
                    fill:false,
                },
                yaxis:{
                    show:true,
                },
                xaxis:{
                    //이 설정은 x축의 보여지는 것이 날짜 기준으로 하기 위해서이다.
                    mode:"categories",
                    show:true,
                },
                legedn:{
                    show:true,
                    noColumns:0,
                    container:$("#line-chart")
                }
            });
             //Initialize tooltip on hover
            $('<div class="tooltip-inner" id="ec-chart-tooltip"></div>').css({
                position: "absolute",
                display: "none",
                opacity: 0.8
            }).appendTo("body");

            $("#line-chart").bind("plothover", function(event, pos, item) {
                                
                if (item) {
                    var x = item.datapoint[0].toFixed(2),
                    y = item.datapoint[1].toFixed(2);
                    //$("#sensor-chart-tooltip").html(item.series.label + " of " + x + " = " + y)
                    $("#line-chart-tooltip").html(item.series.label + " legend : " + y).css({
                        top: item.pageY + 5,
                        left: item.pageX + 5
                    }).fadeIn(200);
                } else {
                    $("#line-chart-tooltip").hide();
                }
            });           
        }
    };
    /*
     * LINE CHART
     * ----------
     */
    //LINE randomly generated data


    var get_Data = function(){
        $.ajax({
            type:"GET",
            url:"/data/ajaxget?serial=<%=serial%>",
            dataType:"json",
            error:function(){
                var ajax_data;
                ajax_data = null;
            },
            success:function(data){
                var chart_data;
                chart_data = data;
                var get_data;
                console.log(data);
                get_data = [getDateFromJSON(data.createdAt), data];

/*
                var show_data = [];
                for (var i = 0, max_data = get_data.length; i < max_data; i++) {
                    console.log(get_data[i]);
                    show_data.push([i, get_data[i].value]);
                    //show_data.push([get_data[i].createAt, get_data[i].value]);
                    console.log(get_data[i].value);
                }
*/

            }
        });
    };

    var get_textData = function(){
        $.ajax({
            type:"GET",
            url:"",
            dtaType:"json",
            error:function(){
                var ajax_data;
                ajax_data = null;
            },
            success:function(data){
                var chart_data;
                console.log(data);
                //ajax_data = JSON.stringify(data);
                chart_data = data;
                var get_data = chart_data;

                if(data_chart.cnt == 0){
                    data_chart.init();
                }else{
                    data_chart.chart.setData();
                    data_chart.chart.setupGrid();
                    data_chart.chart.draw();
                }
            }
        });
    }

    var get_image = function(){
        $.ajax({
            type:"GET",
            url:"/data/ajaximage?serial=<%=serial%>",
            dataType:"json",
            error:function(){
                var ajax_path;
                ajax_path = "/images/failed/failed.jpg";
                
                $("#show_image").find("img").attr("src", ajax_path);
            },
            success:function(data){
                var ajax_data = data;
                var img_path;
                var d = new Data(ajax_data.createdAt);
                var dateStr = d.getFullYear() + "/" + (d.getMonth() + 1) + "/" + d.getDate() + " " + d.getHours() + ":" + d.getMinutes();
                if (ajax_data.createdAt == "") dateStr = "";
                img_path = '/images/' + ajax_data.si_serial + '/' + ajax_data.si_path + '/' + ajax_data.si_filename;
                $("#camera-info").find("img").attr("src", img_path);
            }
        });
    }
    console.log("<%=serial%>")
    get_Data();
    setInterval("get_Data()", 1000 * 60*30);
    get_image();
    setInterval("get_image()", 1000 * 60*30);

});
  </script>
</html>
